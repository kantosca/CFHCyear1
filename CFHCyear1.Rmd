---
title: "CFHCyear1"
author: "Katherine Antosca"
date: "11/27/2018"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#load necessary libraries
library(dada2)
library(ShortRead)
library(ggplot2)
library(breakaway)
library(DivNet)
library(corncob)
library(magrittr)
library(dplyr)
library(vegan)
library(phyloseq)
library(ade4)
library(car)
library(phangorn)
library(multcomp)
library(RColorBrewer)
library(GUniFrac)
library(pheatmap)
library(prettyPCoA)
library(ggsignif)
library(DECIPHER)
library(pheatmap)
library(scatterplot3d)
```




```{r alpha, echo = FALSE}
#read in sample data
sampdf <- read.csv("ClinData.csv")
rownames(sampdf) <- sampdf$mblid

#Remove CF samples after the 1 year time point
year1seqtab <- seqtab.nochim[which(rownames(seqtab.nochim) %in% rownames(sampdf)),]


#Check row order
sampdf <- sampdf[match(rownames(year1seqtab), sampdf$mblid),]
rownames(sampdf) == rownames(year1seqtab)

#convert to phyloseq object

phylo <- phyloseq(otu_table(year1seqtab, taxa_are_rows=FALSE), 
               sample_data(sampdf), 
               tax_table(taxa)) 



alphadiv <- estimate_richness(phylo)
#extract shannon diversity and add it to sampdf
Shannon <- alphadiv$Shannon
Simpson <- alphadiv$Simpson
sampdf <- cbind(sampdf, Shannon, Simpson)
#Set order for plotting by age and Status
sampdf$TimePeriod <- factor(sampdf$TimePeriod, levels = c("6W","4M","6M","9M","12M"))
sampdf$Status <- factor(sampdf$Status, levels = c("HC","CF"))
Greens <- brewer.pal(5,"Greens")
Blues <- brewer.pal(5,"Blues")
GreenBlues <- as.vector(rbind(Greens, Blues))

```  

```{r HCalphaplot, echo = FALSE}
HCalphaplot <- ggplot(data = sampdf[sampdf$Status=="HC",], aes(x = TimePeriod, y = Shannon, 
                                                               group = TimePeriod)) + 
  geom_boxplot(fill = Greens, color = "darkgreen") + 
  geom_signif(comparisons = list(c("6W", "12M")), map_signif_level=TRUE) +
  theme_bw(base_size = 25) +
  xlab("Age in Months") +
  scale_x_discrete(labels = c("1M","4M","6M","9M","12M"))
HCalphaplot
pdf(file = "ShannonHC.pdf",height = 8, width = 12)
  HCalphaplot
dev.off()
```
```{r CFalphaplot, echo = FALSE}
CFalphaplot <- ggplot(data = sampdf[sampdf$Status=="CF",], aes(x = TimePeriod, y = Shannon, group = TimePeriod)) + geom_boxplot(fill = Blues, color = "mediumblue") +
  geom_signif(comparisons = list(c("6W", "12M")), map_signif_level=TRUE) +
  theme_bw(base_size = 25) +
  xlab("Age in Months") +
  scale_x_discrete(labels = c("1M","4M","6M","9M","12M"))
CFalphaplot
pdf(file = "ShannonCF.pdf",height = 8, width = 12)
  CFalphaplot
dev.off()
```

```{r alphaplot, echo = FALSE}
alphaplot <- ggplot(data = sampdf, aes(x = TimePeriod, y = Shannon, color = Status)) + 
  geom_boxplot(fill = GreenBlues) +
  scale_color_manual(values = c("darkgreen", "mediumblue"), 
                     labels = c("General Population", "Cystic Fibrosis"))+
  theme_bw(base_size = 25) +
  xlab("Age in Months") +
  scale_x_discrete(labels = c("1M","4M","6M","9M","12M"))
alphaplot
pdf(file = "ShannonAll.pdf",height = 8, width = 14)
  alphaplot
dev.off()
  

```


```{r phylotree, echo = FALSE}
#multiple alignments with DECIPHER then create the tree with phangorn RaxML via the ips package within R
seqs <- getSequences(year1seqtab)
# This propagates to the tip labels of the tree
names(seqs) <- seqs 
alignment <- AlignSeqs(DNAStringSet(seqs), anchor=NA,verbose=FALSE)

#From https://bioconductor.org/help/course-materials/2017/BioC2017/Day1/Workshops/Microbiome/MicrobiomeWorkflowII.html The phangorn R package is then used to construct a phylogenetic tree. Here we first construct a neighbor-joining tree, and then fit a GTR+G+I (Generalized time-reversible with Gamma rate variation) maximum likelihood tree using the neighbor-joining tree as a starting point.

phangAlign <- phyDat(as(alignment, "matrix"), type="DNA")
dm <- dist.ml(phangAlign)
treeNJ <- NJ(dm) # Note, tip order != sequence order
fit = pml(treeNJ, data=phangAlign)
fitGTR <- update(fit, k=4, inv=0.2)
fitGTR <- optim.pml(fitGTR, model="GTR", optInv=TRUE, optGamma=TRUE,
        rearrangement = "stochastic", control = pml.control(trace = 0))


```



```{r beta, echo = FALSE}
#extracting ASV table
ASV <- as.data.frame(phylo@otu_table@.Data)
#extract tree
tree <- fitGTR$tree
tree <- midpoint(tree)
#calculate GUnifracDistances
unifracs <- GUniFrac(ASV, tree, alpha = c(0, 0.5, 1))$unifracs
#extract distance 0.5
d5 <- unifracs[,,"d_0.5"]
#PERMANOVA
adonis(as.dist(d5) ~ sampdf$Status)

#ordination for plotting
pcs <- pcoa(d5, correction = "cailliez")


rownames(sampdf) == rownames(pcs$vectors)
#modify  sample data for plotting
sampdf <- cbind(sampdf, pcs$vectors[,1:3])

sampdf$StatusAge <- paste(sampdf$TimePeriod,sampdf$Status)
sampdf$StatusAge <- factor(sampdf$StatusAge, 
                           levels = c("6W CF", "6W HC","4M CF", 
                                      "4M HC","6M CF", "6M HC", 
                                      "9M CF","9M HC", "12M CF","12M HC"))

pdf(file = "betaAll.pdf", height = 8, width = 12)
ggplot(sampdf[sampdf$TimePeriod != "6W",], aes(Axis.1,Axis.2, color = StatusAge)) + 
  geom_point(size = 2) +
   labs(x = "PC 1", y = "PC 2")+
  theme_bw(base_size = 25) +
  scale_color_manual(values = GreenBlues[3:10], name = "Age Status")
dev.off()

```


```{r feeding beta, echo = FALSE}

pdf(file = "betaAll.pdf", height = 8, width = 12)
ggplot(sampdf[sampdf$TimePeriod != "6W",], aes(Axis.1,Axis.2, color = StatusAge)) + 
  geom_point(size = 2) +
  scale_shape_manual(values = sampdf$dFeedingModeED, name = "Feeding Mode", labels = c("Breast", "Formula", "Mixed"))+
   labs(x = "PC 1", y = "PC 2")+
  theme_bw(base_size = 25) +
  scale_color_manual(values = GreenBlues[3:10], name = "Age Status")
dev.off()

```
```{r heatmap, echo = FALSE}

#Prepping ASV table for heatmap




pdf("heatmap.pdf")
heatmap
dev.off()


```



```{r taxa, echo = FALSE}

multcomtaxa <- mt(phylo, "Status")
multcomtaxa$adjp
multcomtaxa$Genus[1:25]


```








